name: Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        
    - name: Install dependencies
      run: |
        cd app
        npm install
        
    - name: Run linting
      run: |
        cd app
        npm run lint
        
    - name: Run type checking
      run: |
        cd app
        npm run type-check
        
    - name: Build application
      run: |
        cd app
        npm run build
        
    - name: Run tests with coverage
      run: |
        cd app
        NODE_OPTIONS="--max-old-space-size=8192" npm run test:coverage
        
    - name: Test CLI functionality
      run: |
        cd app
        node dist/cli.js --help
        node dist/cli.js --version
        timeout 3s node dist/cli.js --port 8001 || echo "CLI started successfully"
        
    - name: Production readiness check
      run: |
        cd app
        echo "ğŸ” Running production readiness checks..."
        
        # Check if all required files exist
        echo "ğŸ“ Checking essential files..."
        test -f dist/cli.js || { echo "âŒ CLI entry point missing"; exit 1; }
        test -f dist/index.js || { echo "âŒ Server entry point missing"; exit 1; }
        test -f dist/server.js || { echo "âŒ Server module missing"; exit 1; }
        test -f package.json || { echo "âŒ package.json missing"; exit 1; }
        
        # Check package.json has required fields
        echo "ğŸ“¦ Validating package.json..."
        node -e "const pkg = require('./package.json'); 
        if (!pkg.bin) throw new Error('Missing bin field');
        if (!pkg.bin['claude-wrapper']) throw new Error('Missing claude-wrapper bin');
        if (!pkg.scripts.build) throw new Error('Missing build script');
        if (!pkg.scripts.test) throw new Error('Missing test script');
        console.log('âœ… package.json validation passed');"
        
        # Test CLI can be executed
        echo "ğŸ–¥ï¸ Testing CLI execution..."
        node dist/cli.js --help > /dev/null || { echo "âŒ CLI help failed"; exit 1; }
        
        # Test server starts and responds
        echo "ğŸŒ Testing server startup..."
        timeout 10s bash -c '
        node dist/cli.js --port 8002 &
        SERVER_PID=$!
        sleep 3
        curl -f http://localhost:8002/health || { echo "âŒ Health check failed"; kill $SERVER_PID 2>/dev/null; exit 1; }
        echo "âœ… Server health check passed"
        kill $SERVER_PID 2>/dev/null
        ' || { echo "âŒ Server startup test failed"; exit 1; }
        
        # Check for security vulnerabilities
        echo "ğŸ”’ Checking for security vulnerabilities..."
        npm audit --audit-level high || { echo "âš ï¸ High severity security vulnerabilities found"; exit 1; }
        
        echo "âœ… All production readiness checks passed!"
        
  build-success:
    needs: test
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: Build Success
      run: |
        echo "ğŸ‰ All CI checks passed!"
        echo "âœ… TypeScript compilation successful"
        echo "âœ… Linting passed with no errors"
        echo "âœ… Type checking passed"
        echo "âœ… Test suite passed with coverage"
        echo "âœ… CLI tool fully functional"
        echo "âœ… Server startup and health check passed"
        echo "âœ… Production readiness verified"
        echo "âœ… Security audit passed"
        echo ""
        echo "ğŸš€ Application is PRODUCTION READY!"